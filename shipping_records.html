<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾…è£œè²»ç”¨æŸ¥è©¢ | Bobo Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent-pink: #ff9eb5; --bg-main: #fffafc; --text-primary: #8a5a6a; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-main); color: var(--text-primary); margin: 0; padding: 20px; }
        
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(255, 158, 181, 0.15); }
        h2 { text-align: center; color: var(--text-primary); margin-bottom: 20px; }
        
        .btn-back { display: inline-block; padding: 8px 20px; background: #eee; border-radius: 50px; text-decoration: none; color: #555; margin-bottom: 20px; font-size: 0.9rem; transition: 0.3s; }
        .btn-back:hover { background: #ddd; }

        /* è¡¨æ ¼æ¨£å¼ */
        .record-card { border: 1px solid #ffe3ec; border-radius: 12px; padding: 15px; margin-bottom: 15px; background: #fff; transition: 0.2s; }
        .record-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color: var(--accent-pink); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .batch-tag { background: var(--accent-pink); color: white; padding: 4px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; }
        .total-price { color: #d63384; font-weight: bold; font-size: 1.2rem; }
        
        .card-body { font-size: 0.95rem; line-height: 1.6; color: #555; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .detail-text { background: #f9f9f9; padding: 8px; border-radius: 6px; font-size: 0.85rem; color: #666; margin-top: 8px; }
        .note-text { color: #e67e22; font-size: 0.9rem; margin-top: 5px; font-weight: 500; }

        .loading { text-align: center; color: #999; padding: 20px; }
        .empty-state { text-align: center; padding: 40px; color: #aaa; }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="btn-back">â† å›åˆ°å¤§å»³</a>
        <h2>ğŸ“¦ å¾…è£œè²»ç”¨æŸ¥è©¢</h2>
        <div id="statusArea" class="loading">è³‡æ–™è®€å–ä¸­...</div>
        <div id="listArea"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // é€™è£¡å¡«å…¥è·Ÿ index.html ä¸€æ¨£çš„è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCE95n9P7oeUMDo_LGffDt9H8pGtpmUOFw",
            authDomain: "my-shop-2026-1b573.firebaseapp.com",
            projectId: "my-shop-2026-1b573",
            storageBucket: "my-shop-2026-1b573.firebasestorage.app",
            messagingSenderId: "15775390058",
            appId: "1:15775390058:web:ef08a6b8bca2657ecbed13"
        };
        
        // ä½ çš„ GAS ç¶²å€ (è¨˜å¾—è¦ç”¨æœ€æ–°éƒ¨ç½²çš„ç¶²å€)
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzVo9_FACAbkJnnIIXTXu4g4pgCSPKrx9q90Ywd1_rlbXsbmmAmnAprbAbfnB-akdLhtA/exec";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                fetchShippingRecords(user.email);
            } else {
                document.getElementById('statusArea').innerHTML = "è«‹å…ˆå›åˆ°é¦–é ç™»å…¥æœƒå“¡ã€‚ <br><a href='index.html'>å‰å¾€ç™»å…¥</a>";
            }
        });

        async function fetchShippingRecords(email) {
            try {
                // å‘¼å« GAS API: action=get_shipping_records
                const res = await fetch(`${GAS_URL}?action=get_shipping_records&email=${encodeURIComponent(email)}`);
                const json = await res.json();

                if (json.status === "success") {
                    renderList(json.data);
                } else {
                    document.getElementById('statusArea').innerText = "æŸ¥è©¢å¤±æ•—ï¼š" + json.message;
                }
            } catch (e) {
                console.error(e);
                document.getElementById('statusArea').innerText = "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
            }
        }

        // --- (æ–°åŠŸèƒ½) æ—¥æœŸæ ¼å¼åŒ–å°å·¥å…· ---
        function formatDate(isoString) {
            if (!isoString) return "";
            // å°‡ ISO æ™‚é–“å­—ä¸²è½‰ç‚º Date ç‰©ä»¶ (æœƒè‡ªå‹•è½‰ç‚ºç€è¦½å™¨ç•¶åœ°æ™‚é–“)
            const date = new Date(isoString);
            
            // æª¢æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
            if (isNaN(date.getTime())) return isoString; // å¦‚æœä¸æ˜¯æ—¥æœŸï¼Œå°±åŸæ¨£é¡¯ç¤º

            // è¼¸å‡ºæ ¼å¼ï¼šYYYY/MM/DD
            return date.getFullYear() + '/' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                   String(date.getDate()).padStart(2, '0');
        }

        function renderList(data) {
            const listArea = document.getElementById('listArea');
            const statusArea = document.getElementById('statusArea');
            
            if (data.length === 0) {
                statusArea.style.display = 'none';
                listArea.innerHTML = `<div class="empty-state">ğŸ‰ å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰å¾…è£œè²»ç”¨ã€‚</div>`;
                return;
            }

            statusArea.style.display = 'none';
            let html = "";
            
            data.forEach(item => {
                // è™•ç†å‚™è¨»é¡¯ç¤º
                const noteHtml = item.note ? `<div class="note-text">âš ï¸ å‚™è¨»ï¼š${item.note}</div>` : '';
                
                // --- (ä¿®æ”¹è™•) é€™è£¡å¥—ç”¨äº† formatDate ---
                html += `
                <div class="record-card">
                    <div class="card-header">
                        <span class="batch-tag">${formatDate(item.batch)}</span> 
                        <span class="total-price">$${item.total}</span>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <span>ğŸ“¦ åŒ…è£¹ä»¶æ•¸</span>
                            <strong>${item.count} ä»¶</strong>
                        </div>
                        <div class="info-row">
                            <span>âš–ï¸ è¨ˆåƒ¹é‡é‡</span>
                            <strong>${item.weight} kg</strong>
                        </div>
                        <div class="detail-text">
                            ${item.detail}
                        </div>
                        ${noteHtml}
                    </div>
                </div>`;
            });
            
            listArea.innerHTML = html;
        }
    </script>
</body>
</html>
