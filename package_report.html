<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ…è£¹å›å ± | Bobo_studio.dodo</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --text-primary: #8a5a6a; --text-secondary: #b38996; --accent-pink: #ff9eb5; --accent-hover: #ff7a96; --bg-main: #fffafc; --bg-card: #ffffff; }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; background-color: var(--bg-main); color: var(--text-primary); }
        
        header { background: rgba(255, 255, 255, 0.9); padding: 0.8rem 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ffe3ec; }
        .logo-text { font-weight: bold; font-size: 1.2rem; color: var(--text-primary); }
        
        .container { max-width: 800px; margin: 2rem auto; padding: 0 1.5rem 4rem 1.5rem; }
        .card { background: var(--bg-card); border-radius: 20px; padding: 2rem; box-shadow: 0 10px 25px rgba(255, 158, 181, 0.15); border: 1px solid #ffe3ec; margin-bottom: 25px; }
        
        .btn { background-color: var(--accent-pink); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; transition: 0.3s; font-size: 1rem; width: 100%; margin-top: 15px; }
        .btn:hover { background-color: var(--accent-hover); transform: translateY(-2px); }
        .btn-back { background-color: #eee; color: #666; border: none; padding: 8px 15px; border-radius: 50px; cursor: pointer; font-size: 0.9rem; transition: 0.3s; }
        .btn-back:hover { background-color: #ddd; }

        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ffe3ec; border-radius: 10px; background: #fffafa; font-size: 1rem; color: #555; }
        .form-input:focus { outline: none; border-color: var(--accent-pink); background: white; }

        /* æ­·å²ç´€éŒ„åˆ—è¡¨æ¨£å¼ */
        .pkg-item { padding: 15px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; }
        .pkg-item:last-child { border-bottom: none; }
        
        .pkg-info { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .pkg-track { font-weight: bold; color: #555; font-size: 1.05rem; }
        .pkg-meta { font-size: 0.9rem; color: #888; }
        .pkg-weight { font-size: 0.9rem; color: #e67e22; font-weight: bold; margin-left: 5px; background: #fff3e0; padding: 2px 6px; border-radius: 4px; }

        .pkg-status-col { text-align: right; min-width: 80px; }
        .pkg-status { display: inline-block; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; color: white; }
        
        /* ç‹€æ…‹é¡è‰²å®šç¾© */
        .st-default { background-color: #95a5a6; } /* å¾…å…¥åº« (ç°) */
        .st-in { background-color: #27ae60; }      /* å·²å…¥åº« (ç¶ ) */
        .st-shipping { background-color: #2980b9; } /* é›†é‹ä¸­ (è—) */
        .st-packing { background-color: #f39c12; }  /* æ•´ç†ä¸­ (æ©˜) */
        .st-out { background-color: #8e44ad; }      /* å·²å‡ºè²¨ (ç´«) */
    </style>
</head>
<body>

    <header>
        <div class="logo-text">å¿«éåŒ…è£¹å›å ±</div>
        <button class="btn-back" onclick="location.href='index.html'">â¬… å›å¤§å»³</button>
    </header>

    <div class="container">
        <div class="card">
            <h3 style="margin-top:0; border-left:4px solid var(--accent-pink); padding-left:10px;">ğŸ“¦ æ–°å¢åŒ…è£¹å›å ±</h3>
            <div style="margin-bottom:20px;">
                <label class="form-label">å¿«éå–®è™Ÿ (Tracking Number) <span style="color:red">*</span></label>
                <input type="text" id="trackingNum" class="form-input" placeholder="è«‹è¼¸å…¥å®Œæ•´çš„å–®è™Ÿ">
            </div>
            <div style="margin-bottom:20px;">
                <label class="form-label">å¿«éå…¬å¸ (Carrier)</label>
                <input type="text" id="carrier" class="form-input" placeholder="ä¾‹å¦‚ï¼šä¸­é€šã€åœ“é€šã€é †è±">
            </div>
            <div style="margin-bottom:20px;">
                <label class="form-label">åŒ…è£¹å…§å®¹/å‚™è¨» <span style="color:red">*</span></label>
                <input type="text" id="note" class="form-input" placeholder="ä¾‹å¦‚ï¼šè¡£æœ x 3, æ˜“ç¢å“">
            </div>
            <button class="btn" onclick="submitPackage()">ğŸ“¤ æäº¤å›å ±å–®</button>
        </div>

        <div class="card">
            <h3 style="margin-top:0; border-left:4px solid #b38996; padding-left:10px;">ğŸ“‹ æˆ‘çš„å›å ±ç´€éŒ„</h3>
            <div id="loadingText" style="text-align:center; color:#999; padding:20px;">è®€å–ä¸­...</div>
            <div id="pkgList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // âœ… Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCE95n9P7oeUMDo_LGffDt9H8pGtpmUOFw",
            authDomain: "my-shop-2026-1b573.firebaseapp.com",
            projectId: "my-shop-2026-1b573",
            storageBucket: "my-shop-2026-1b573.firebasestorage.app",
            messagingSenderId: "15775390058",
            appId: "1:15775390058:web:ef08a6b8bca2657ecbed13"
        };
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzVo9_FACAbkJnnIIXTXu4g4pgCSPKrx9q90Ywd1_rlbXsbmmAmnAprbAbfnB-akdLhtA/exec";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let currentUserEmail = "";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserEmail = user.email;
                loadPackages(); 
            } else {
                alert("è«‹å…ˆç™»å…¥");
                location.href = "index.html";
            }
        });

        window.submitPackage = async () => {
            const trackingNum = document.getElementById('trackingNum').value;
            const carrier = document.getElementById('carrier').value;
            const note = document.getElementById('note').value;

            // ğŸŸ¢ ä¿®æ”¹ï¼šé©—è­‰å–®è™Ÿèˆ‡å…§å®¹çš†ç‚ºå¿…å¡«
            if (!trackingNum || !note) { 
                alert("âŒ è«‹å‹™å¿…å¡«å¯«å¿«éå–®è™Ÿèˆ‡åŒ…è£¹å…§å®¹ï¼"); 
                return; 
            }

            const btn = document.querySelector("button[onclick='submitPackage()']");
            btn.innerText = "æäº¤ä¸­..."; btn.disabled = true;

            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "save_package",
                        email: currentUserEmail,
                        trackingNum: trackingNum,
                        carrier: carrier,
                        note: note
                    })
                });
                const json = await res.json();
                alert(json.message);
                
                document.getElementById('trackingNum').value = "";
                document.getElementById('carrier').value = "";
                document.getElementById('note').value = "";
                loadPackages();

            } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
            finally { btn.innerText = "ğŸ“¤ æäº¤å›å ±å–®"; btn.disabled = false; }
        };

        async function loadPackages() {
            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_packages", email: currentUserEmail })
                });
                const json = await res.json();
                const list = document.getElementById('pkgList');
                document.getElementById('loadingText').style.display = 'none';

                if (json.data && json.data.length > 0) {
                    let html = "";
                    json.data.forEach(pkg => {
                        // ç‹€æ…‹é¡è‰²åˆ¤æ–·
                        let stClass = "st-default";
                        if (pkg.status.includes("å·²å…¥åº«")) stClass = "st-in";
                        else if (pkg.status.includes("é›†é‹ä¸­")) stClass = "st-shipping";
                        else if (pkg.status.includes("æ•´ç†ä¸­")) stClass = "st-packing";
                        else if (pkg.status.includes("å·²å‡ºè²¨")) stClass = "st-out";

                        // é‡é‡é¡¯ç¤ºåˆ¤æ–·
                        let weightHtml = pkg.weight ? `<span class="pkg-weight">âš–ï¸ ${pkg.weight} KG</span>` : "";

                        html += `
                        <div class="pkg-item">
                            <div class="pkg-info">
                                <div class="pkg-track">
                                    ${pkg.trackingNum} 
                                    ${weightHtml}
                                </div>
                                <div class="pkg-meta">
                                    ${pkg.carrier || "æœªå¡«å¿«é"} | ${pkg.note || "ç„¡å‚™è¨»"} | ${pkg.time.split('T')[0]}
                                </div>
                            </div>
                            <div class="pkg-status-col">
                                <span class="pkg-status ${stClass}">${pkg.status}</span>
                            </div>
                        </div>`;
                    });
                    list.innerHTML = html;
                } else {
                    list.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">å°šç„¡å›å ±ç´€éŒ„</div>';
                }
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>
