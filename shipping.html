<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯„ä»¶è³‡æ–™è¨­å®š | Bobo_studio.dodo</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --text-primary: #8a5a6a; --text-secondary: #b38996; --accent-pink: #ff9eb5; --accent-hover: #ff7a96; --bg-main: #fffafc; --bg-card: #ffffff; --danger: #e74c3c; }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; background-color: var(--bg-main); color: var(--text-primary); }
        
        header { background: rgba(255, 255, 255, 0.9); padding: 0.8rem 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ffe3ec; }
        .logo-text { font-weight: bold; font-size: 1.2rem; color: var(--text-primary); }
        
        .container { max-width: 700px; margin: 2rem auto; padding: 0 1.5rem 4rem 1.5rem; }
        .card { background: var(--bg-card); border-radius: 20px; padding: 2.5rem; box-shadow: 0 10px 25px rgba(255, 158, 181, 0.15); border: 1px solid #ffe3ec; }
        
        .btn { background-color: var(--accent-pink); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; transition: 0.3s; font-size: 1rem; width: 100%; margin-top: 20px; }
        .btn:hover { background-color: var(--accent-hover); transform: translateY(-2px); }
        
        /* å›å¤§å»³æŒ‰éˆ• */
        .btn-back { background-color: #eee; color: #666; border: none; padding: 8px 15px; border-radius: 50px; cursor: pointer; font-size: 0.9rem; transition: 0.3s; }
        .btn-back:hover { background-color: #ddd; }

        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #ffe3ec; padding-bottom: 10px; }
        .tab-btn { flex: 1; text-align: center; padding: 12px; cursor: pointer; border-radius: 10px; font-weight: bold; color: var(--text-secondary); background: transparent; border: none; transition: 0.3s; }
        .tab-btn.active { background-color: var(--accent-pink); color: white; box-shadow: 0 4px 10px rgba(255, 158, 181, 0.3); }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .form-section-title { font-size: 1.1rem; font-weight: 700; margin: 25px 0 15px 0; color: var(--text-primary); border-left: 4px solid var(--accent-pink); padding-left: 10px; background: #fff5f7; padding: 8px 10px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ffe3ec; border-radius: 10px; background: #fffafa; font-size: 1rem; color: #555; }
        .form-input:focus { outline: none; border-color: var(--accent-pink); background: white; }
        .readonly-input { background: #f0f0f0; color: #888; cursor: not-allowed; }
        .form-row { display: flex; gap: 15px; }

        .error-message { color: var(--danger); font-size: 0.85rem; margin-top: 5px; display: none; }
        .input-error { border-color: var(--danger) !important; background: #fff0f0; }
        
        .hint-tag { background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 5px; vertical-align: middle; }
        .radio-group { display: flex; flex-direction: column; gap: 10px; }
        .radio-label { display: flex; align-items: center; cursor: pointer; }
        .radio-label input { margin-right: 10px; accent-color: var(--accent-pink); width: 18px; height: 18px; }

        @media (max-width: 480px) { .form-row { flex-direction: column; gap: 15px; } }
    </style>
</head>
<body>

    <header>
        <div class="logo-text">å¯„ä»¶è³‡æ–™è¨­å®š</div>
        <button class="btn-back" onclick="location.href='index.html'">â¬… å›å¤§å»³</button>
    </header>

    <div class="container">
        <div id="loadingOverlay" style="text-align:center; padding: 50px;"><h3>ğŸ”„ è®€å–å¯„ä»¶è³‡æ–™...</h3></div>

        <div class="card" id="formCard" style="display:none;">
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('store')">ğŸª 7-11 è¶…å•†å–è²¨</button>
                <button class="tab-btn" onclick="switchTab('postal')">ğŸšš éƒµå¯„å®…é…</button>
            </div>

            <div id="tab-store" class="tab-content active">
                <div class="form-section-title">å–ä»¶äººè³‡è¨Š</div>
                <div class="form-group">
                    <label class="form-label">å–ä»¶äººå§“å <span style="font-size:0.85rem; color:#888;">(è‡ªå‹•ç¶å®šæœƒå“¡)</span></label>
                    <input type="text" id="shipName" class="form-input readonly-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="hint-tag">iOpenMall æœƒå“¡</span></label>
                    <input type="tel" id="shipPhone" class="form-input" maxlength="10" placeholder="è«‹è¼¸å…¥ iOpenMall æœƒå“¡é›»è©±" onblur="validatePhone(this)" oninput="restrictNum(this)">
                    <span class="error-message">âŒ æ ¼å¼éŒ¯èª¤</span>
                </div>

                <div class="form-section-title">7-11 é–€å¸‚è³‡è¨Š</div>
                <div class="form-group">
                    <label class="form-label">é–€å¸‚åº—è™Ÿ (6ç¢¼)</label>
                    <input type="text" id="storeCode" class="form-input" maxlength="6" placeholder="ä¾‹å¦‚ï¼š123456" oninput="restrictNum(this)">
                    <div style="margin-top:5px; font-size:0.85rem;"><a href="https://emap.presco.com.tw/c2cemap.ashx" target="_blank" style="color:var(--accent-hover);">ğŸ”— æŸ¥è©¢åº—è™Ÿ</a></div>
                </div>
                <div class="form-group">
                    <label class="form-label">é–€å¸‚åç¨±</label>
                    <input type="text" id="storeName" class="form-input" placeholder="ä¾‹å¦‚ï¼šXXé–€å¸‚">
                </div>
                <button class="btn" onclick="saveData('store')">ğŸ’¾ å„²å­˜è¶…å•†è³‡æ–™</button>
            </div>

            <div id="tab-postal" class="tab-content">
                <div class="form-section-title">æ”¶ä»¶äººè³‡è¨Š</div>
                <div class="form-group">
                    <label class="form-label">æ”¶ä»¶äººå§“å <span style="font-size:0.85rem; color:#888;">(è‡ªå‹•ç¶å®šæœƒå“¡)</span></label>
                    <input type="text" id="postalName" class="form-input readonly-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">è¯çµ¡é›»è©±</label>
                    <input type="tel" id="postalPhone" class="form-input" maxlength="10" placeholder="09xxxxxxxx" onblur="validatePhone(this)" oninput="restrictNum(this)">
                    <span class="error-message">âŒ æ ¼å¼éŒ¯èª¤</span>
                </div>

                <div class="form-section-title">å¯„é€åœ°å€</div>
                <div class="form-row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">éƒµéå€è™Ÿ</label>
                        <input type="text" id="postalZip" class="form-input" maxlength="5" placeholder="3+2ç¢¼" oninput="restrictNum(this)">
                    </div>
                    <div class="form-group" style="flex:3">
                        <label class="form-label">è©³ç´°åœ°å€</label>
                        <input type="text" id="postalAddr" class="form-input" placeholder="ç¸£å¸‚/å€/è·¯/å··/è™Ÿ/æ¨“">
                    </div>
                </div>

                <div class="form-section-title">æŠ•éå¤±æ•—è™•ç†</div>
                <div class="form-group">
                    <label class="form-label">è‹¥ç„¡äººç°½æ”¶æˆ–æ‹›é ˜é€¾æœŸï¼š</label>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="postalAction" value="return" checked> é€€å›åŸå¯„ä»¶äºº (è²·å®¶éœ€è² æ“”é‡æ–°å¯„é€é‹è²»)</label>
                        <label class="radio-label"><input type="radio" name="postalAction" value="discard"> ç›´æ¥ä¸Ÿæ£„ (ä¸é€€æ¬¾)</label>
                    </div>
                </div>
                <button class="btn" onclick="saveData('postal')" style="background-color:#2980b9;">ğŸšš å„²å­˜éƒµå¯„è³‡æ–™</button>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // âœ… æ‚¨çš„ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCE95n9P7oeUMDo_LGffDt9H8pGtpmUOFw",
            authDomain: "my-shop-2026-1b573.firebaseapp.com",
            projectId: "my-shop-2026-1b573",
            storageBucket: "my-shop-2026-1b573.firebasestorage.app",
            messagingSenderId: "15775390058",
            appId: "1:15775390058:web:ef08a6b8bca2657ecbed13"
        };
        
        // âœ… æ‚¨çš„ GAS å¾Œç«¯ç¶²å€
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzVo9_FACAbkJnnIIXTXu4g4pgCSPKrx9q90Ywd1_rlbXsbmmAmnAprbAbfnB-akdLhtA/exec";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let currentUserEmail = "";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserEmail = user.email;
                try {
                    // 1. æŠ“å–åŸºæœ¬è³‡æ–™ (ç‚ºäº†æ‹¿çœŸå¯¦å§“å)
                    const resMember = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "google_login", email: user.email, name: user.displayName }) });
                    const jsonMember = await resMember.json();
                    
                    let realName = user.displayName; // é è¨­ç”¨ Google æš±ç¨±
                    if(jsonMember.data && jsonMember.data.name) {
                        realName = jsonMember.data.name;
                    } else {
                        alert("âš ï¸ æé†’ï¼šæ‚¨å°šæœªå¡«å¯«ã€Œæœƒå“¡åŸºæœ¬è³‡æ–™ã€ï¼Œå»ºè­°å…ˆè‡³æœƒå“¡ä¸­å¿ƒå¡«å¯«ï¼Œé€™è£¡æ‰æœƒè‡ªå‹•å¸¶å…¥æ­£ç¢ºå§“åï¼");
                    }
                    
                    document.getElementById('shipName').value = realName;
                    document.getElementById('postalName').value = realName;

                    // 2. æŠ“å–å·²å„²å­˜çš„å¯„ä»¶è³‡æ–™ (action: "get_shipping")
                    const resShip = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_shipping", email: user.email }) });
                    const jsonShip = await resShip.json();

                    if(jsonShip.status === "found") {
                        // å¡«å…¥è¶…å•†è³‡æ–™
                        if(jsonShip.data.phone) document.getElementById('shipPhone').value = jsonShip.data.phone;
                        if(jsonShip.data.storeCode) document.getElementById('storeCode').value = jsonShip.data.storeCode;
                        if(jsonShip.data.storeName) document.getElementById('storeName').value = jsonShip.data.storeName;
                        
                        // å¡«å…¥éƒµå¯„è³‡æ–™
                        if(jsonShip.data.phone) document.getElementById('postalPhone').value = jsonShip.data.phone; // å…±ç”¨é›»è©±
                        if(jsonShip.data.postalZip) document.getElementById('postalZip').value = jsonShip.data.postalZip;
                        if(jsonShip.data.postalAddr) document.getElementById('postalAddr').value = jsonShip.data.postalAddr;
                        if(jsonShip.data.postalAction) {
                            const radios = document.getElementsByName('postalAction');
                            for(let r of radios) { if(r.value === jsonShip.data.postalAction) r.checked = true; }
                        }
                    }

                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('formCard').style.display = 'block';

                } catch (e) {
                    console.error(e);
                    alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                }
            } else {
                alert("è«‹å…ˆç™»å…¥");
                location.href = "index.html";
            }
        });

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            event.target.classList.add('active');
        };

        window.restrictNum = (el) => el.value = el.value.replace(/[^\d]/g, '');
        window.validatePhone = (el) => {
            const valid = /^09\d{8}$/.test(el.value);
            el.nextElementSibling.style.display = valid ? 'none' : 'block';
            el.classList.toggle('input-error', !valid);
        };

        window.saveData = async (type) => {
            const btn = event.target;
            const originalText = btn.innerText;
            
            // ç°¡æ˜“é©—è­‰
            if(type === 'store') {
                if(!document.getElementById('shipPhone').value || !document.getElementById('storeCode').value) {
                    alert("âŒ è«‹å®Œæ•´å¡«å¯«è¶…å•†è³‡æ–™"); return;
                }
            } else {
                if(!document.getElementById('postalPhone').value || !document.getElementById('postalZip').value || !document.getElementById('postalAddr').value) {
                    alert("âŒ è«‹å®Œæ•´å¡«å¯«éƒµå¯„è³‡æ–™"); return;
                }
            }

            btn.innerText = "è™•ç†ä¸­...";
            btn.disabled = true;

            const payload = {
                action: "save_shipping",
                email: currentUserEmail,
                type: type, // å‘Šè¨´å¾Œç«¯æ˜¯å­˜ 'store' é‚„æ˜¯ 'postal'
                recipient: document.getElementById('shipName').value, // å§“åæ˜¯å…±ç”¨çš„
                phone: type === 'store' ? document.getElementById('shipPhone').value : document.getElementById('postalPhone').value,
                
                // è¶…å•†æ¬„ä½
                storeCode: document.getElementById('storeCode').value,
                storeName: document.getElementById('storeName').value,
                
                // éƒµå¯„æ¬„ä½
                postalZip: document.getElementById('postalZip').value,
                postalAddr: document.getElementById('postalAddr').value,
                postalAction: document.querySelector('input[name="postalAction"]:checked').value
            };

            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
                const json = await res.json();
                if(json.status === "success") {
                    alert("âœ… è³‡æ–™å„²å­˜æˆåŠŸï¼");
                } else {
                    alert("âŒ å„²å­˜å¤±æ•—ï¼š" + json.message);
                }
            } catch(e) {
                alert("é€£ç·šéŒ¯èª¤");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>