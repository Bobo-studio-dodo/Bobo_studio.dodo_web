<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡åŸºæœ¬è³‡æ–™ | Bobo_studio.dodo</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --text-primary: #8a5a6a; --text-secondary: #b38996; --accent-pink: #ff9eb5; --accent-hover: #ff7a96; --bg-main: #fffafc; --bg-card: #ffffff; --danger: #e74c3c; }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; background-color: var(--bg-main); color: var(--text-primary); }
        header { background: rgba(255, 255, 255, 0.9); padding: 0.8rem 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ffe3ec; }
        .logo-text { font-weight: bold; font-size: 1.2rem; color: var(--text-primary); }
        .container { max-width: 700px; margin: 2rem auto; padding: 0 1.5rem 4rem 1.5rem; }
        .card { background: var(--bg-card); border-radius: 20px; padding: 2.5rem; box-shadow: 0 10px 25px rgba(255, 158, 181, 0.15); border: 1px solid #ffe3ec; }
        .btn { background-color: var(--accent-pink); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; transition: 0.3s; font-size: 1rem; width: 100%; margin-top: 10px; }
        .btn:hover { background-color: var(--accent-hover); transform: translateY(-2px); }
        .btn-back { background-color: #ddd; color: #555; margin-right: 10px; width: auto; margin-top: 0;}
        .form-section-title { font-size: 1.1rem; font-weight: 700; margin: 30px 0 20px 0; color: var(--text-primary); border-bottom: 2px solid #ffe3ec; padding-bottom: 5px;}
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input, select { width: 100%; padding: 12px; border: 1px solid #ffe3ec; border-radius: 10px; background: #fffafa; font-size: 1rem; color: #555; }
        .form-input:focus { outline: none; border-color: var(--accent-pink); background: white; }
        .form-row { display: flex; gap: 15px; }
        .required { color: var(--danger); margin-left: 3px; }
        .error-message { color: var(--danger); font-size: 0.85rem; margin-top: 5px; display: none; }
        .input-error { border-color: var(--danger) !important; background: #fff0f0; }
        .readonly-input { background: #f0f0f0; color: #888; cursor: not-allowed; }
        .radio-group { display: flex; gap: 20px; margin-top: 10px; }
        .radio-label { display: flex; align-items: center; cursor: pointer; }
        .radio-label input { margin-right: 8px; accent-color: var(--accent-pink); width: 18px; height: 18px; }
        
        /* æœƒå“¡ç·¨è™Ÿç‰¹åˆ¥æ¨£å¼ */
        .id-badge { background: #666; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 5px; }

        @media (max-width: 480px) { .form-row { flex-direction: column; gap: 15px; } }
    </style>
</head>
<body>
    <header>
        <div class="logo-text">æœƒå“¡åŸºæœ¬è³‡æ–™</div>
        <button class="btn btn-back" onclick="location.href='index.html'">å›å¤§å»³</button>
    </header>
    <div class="container">
        <div id="loadingOverlay" style="text-align:center; padding: 50px;"><h3>ğŸ”„ è®€å–è³‡æ–™ä¸­...</h3></div>
        <div class="card" id="formCard" style="display:none;">
            <div class="form-section-title">1. åŸºæœ¬è³‡æ–™</div>
            
            <div class="form-group">
                <label class="form-label">æœƒå“¡ç·¨è™Ÿ <span class="id-badge">ç³»çµ±æ ¸ç™¼</span></label>
                <input type="text" id="memberId" class="form-input readonly-input" disabled placeholder="å¾…ç®¡ç†å“¡æ ¸ç™¼">
            </div>

            <div class="form-group"><label class="form-label">é›»å­ä¿¡ç®±</label><input type="text" id="inputEmail" class="form-input readonly-input" disabled></div>
            <div class="form-row">
                <div class="form-group" style="flex:1"><label class="form-label">çœŸå¯¦å§“å <span class="required">*</span></label><input type="text" id="realName" class="form-input" placeholder="ä¸­æ–‡å…¨å" onblur="validateName(this)"><span class="error-message">âŒ é™ 2-5 å­—ç´”ä¸­æ–‡</span></div>
                <div class="form-group" style="flex:1"><label class="form-label">ç”Ÿç†æ€§åˆ¥ <span class="required">*</span></label><div class="radio-group"><label class="radio-label"><input type="radio" name="gender" value="å¥³" checked> å¥³æ€§</label><label class="radio-label"><input type="radio" name="gender" value="ç”·"> ç”·æ€§</label></div></div>
            </div>
            <div class="form-group"><label class="form-label">å‡ºç”Ÿå¹´æœˆæ—¥ <span class="required">*</span></label><input type="date" id="dob" class="form-input" onchange="checkAge(this)"><span class="error-message">âŒ éœ€å¹´æ»¿ 14 æ­²ä¸”ä¸å¯ç‚ºæœªä¾†æ—¥æœŸ</span></div>
            <div class="form-group"><label class="form-label">é›»è©±è™Ÿç¢¼ <span class="required">*</span></label><input type="tel" id="phone" class="form-input" maxlength="10" placeholder="09xxxxxxxx" onblur="validatePhone(this)" oninput="restrictNum(this)"><span class="error-message">âŒ æ ¼å¼éŒ¯èª¤</span></div>
            <div class="form-group"><label class="form-label">Line è¯çµ¡æ–¹å¼ <span class="required">*</span></label><div class="radio-group" style="margin-bottom:10px;"><label class="radio-label"><input type="radio" name="lineType" value="id" checked onchange="switchLineMode()"> ID</label><label class="radio-label"><input type="radio" name="lineType" value="phone" onchange="switchLineMode()"> é›»è©±</label></div><input type="text" id="lineInput" class="form-input" placeholder="è«‹è¼¸å…¥ Line ID" onblur="validateLine(this)"><div id="lineHint" style="font-size:0.85rem;color:#888;margin-top:5px;">ID éœ€ç‚º 2-20 å­—å…ƒï¼Œåƒ…é™å°å¯«è‹±æ–‡ã€æ•¸å­—åŠç¬¦è™Ÿ</div><span class="error-message" id="lineError"></span></div>

            <div class="form-section-title">2. å¯¦åèˆ‡ä»˜/é€€æ¬¾å¸³æˆ¶</div>
            <div class="form-group"><label class="form-label">éŠ€è¡Œä»£ç¢¼ (3ç¢¼) <span class="required">*</span></label><select id="bankCode" class="form-input" onchange="handleBankChange(this)"><option value="" disabled selected>è«‹é¸æ“‡éŠ€è¡Œ</option><option value="391">391 - ä¸€å¡é€šæ©Ÿæ§‹</option><option value="004">004 - å°ç£éŠ€è¡Œ</option><option value="005">005 - åœŸåœ°éŠ€è¡Œ</option><option value="006">006 - åˆä½œé‡‘åº«</option><option value="007">007 - ç¬¬ä¸€éŠ€è¡Œ</option><option value="008">008 - è¯å—éŠ€è¡Œ</option><option value="009">009 - å½°åŒ–éŠ€è¡Œ</option><option value="011">011 - ä¸Šæµ·éŠ€è¡Œ</option><option value="012">012 - å°åŒ—å¯Œé‚¦</option><option value="013">013 - åœ‹æ³°ä¸–è¯</option><option value="017">017 - å…†è±å•†éŠ€</option><option value="700">700 - ä¸­è¯éƒµæ”¿</option><option value="812">812 - å°æ–°éŠ€è¡Œ</option><option value="822">822 - ä¸­åœ‹ä¿¡è¨—</option><option value="824">824 - é€£ç·šå•†æ¥­éŠ€è¡Œ (LINE Bank)</option><option value="manual">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input id="bankCodeManual" class="form-input" placeholder="3ç¢¼ä»£è™Ÿ" maxlength="3" style="margin-top:10px; display:none;" oninput="restrictNum(this)"></div>
            <div class="form-group"><label class="form-label">éŠ€è¡Œåç¨±</label><input type="text" id="bankName" class="form-input readonly-input" readonly placeholder="ç³»çµ±è‡ªå‹•å¸¶å…¥"></div>
            <div class="form-row"><div class="form-group" style="flex:2"><label class="form-label">éŠ€è¡Œå¸³è™Ÿ <span class="required">*</span></label><input type="text" id="bankAccount" class="form-input" maxlength="16" placeholder="è«‹è¼¸å…¥å­˜æ‘ºå¸³è™Ÿ" onblur="validateAccount(this)" oninput="restrictNum(this)"><span class="error-message"></span></div><div class="form-group" style="flex:1"><label class="form-label">åˆ†è¡Œåç¨±</label><input type="text" id="branchName" class="form-input" placeholder="ä¾‹ï¼šåŸä¸­åˆ†è¡Œ"></div></div>
            <button onclick="saveData()" class="btn">ğŸ’¾ å„²å­˜è³‡æ–™</button>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "AIzaSyCE95n9P7oeUMDo_LGffDt9H8pGtpmUOFw", authDomain: "my-shop-2026-1b573.firebaseapp.com", projectId: "my-shop-2026-1b573", storageBucket: "my-shop-2026-1b573.firebasestorage.app", messagingSenderId: "15775390058", appId: "1:15775390058:web:ef08a6b8bca2657ecbed13" };
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzVo9_FACAbkJnnIIXTXu4g4pgCSPKrx9q90Ywd1_rlbXsbmmAmnAprbAbfnB-akdLhtA/exec";
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let currentUserEmail = "";
        
        document.getElementById('dob').setAttribute('max', new Date().toISOString().split("T")[0]);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserEmail = user.email;
                document.getElementById('inputEmail').value = user.email;
                try {
                    const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "google_login", email: user.email, name: user.displayName }) });
                    const json = await res.json();
                    fillForm(json.data);
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('formCard').style.display = 'block';
                } catch (e) { alert("è®€å–è³‡æ–™å¤±æ•—"); console.error(e); }
            } else { alert("è«‹å…ˆç™»å…¥"); location.href = "index.html"; }
        });

        // æ™ºæ…§å¡«è¡¨ (åŒ…å«å–®å¼•è™Ÿéæ¿¾)
        function fillForm(data) {
            const clean = (val) => val ? String(val).replace(/^'/, '') : "";

            if(data.id) document.getElementById('memberId').value = data.id || "æœªæ ¸ç™¼";
            if(data.name) document.getElementById('realName').value = clean(data.name);
            
            if(data.birthday) {
                let dateStr = clean(data.birthday);
                if(dateStr.includes("T")) dateStr = dateStr.split("T")[0];
                document.getElementById('dob').value = dateStr;
            }

            if(data.phone) document.getElementById('phone').value = clean(data.phone);

            if(data.lineInfo) {
                let lineVal = clean(data.lineInfo);
                const lineInput = document.getElementById('lineInput');
                const radios = document.getElementsByName('lineType');
                if (lineVal.startsWith("(é›»è©±)")) {
                    radios[1].checked = true;
                    lineInput.value = lineVal.replace("(é›»è©±) ", "").trim();
                    switchLineMode();
                } else {
                    radios[0].checked = true;
                    lineInput.value = lineVal;
                    switchLineMode();
                }
            }

            if(data.gender) { 
                const gVal = clean(data.gender);
                const radios = document.getElementsByName('gender'); 
                for(let r of radios) { if(r.value === gVal) r.checked = true; } 
            }

            if(data.bankCode) { 
                let code = clean(data.bankCode);
                const bankSelect = document.getElementById('bankCode');
                let found = false;
                for(let opt of bankSelect.options) {
                    if(opt.value === code) { bankSelect.value = code; found = true; break; }
                }
                if(!found && code) {
                    bankSelect.value = 'manual';
                    document.getElementById('bankCodeManual').value = code;
                }
                handleBankChange(bankSelect);
            }
            
            if(data.bankName) document.getElementById('bankName').value = clean(data.bankName);
            if(data.account) document.getElementById('bankAccount').value = clean(data.account);
            if(data.branch) document.getElementById('branchName').value = clean(data.branch);
        }

        window.restrictNum = (el) => el.value = el.value.replace(/[^\d]/g, '');
        window.validateName = (el) => toggleError(el, el.value && /^[\u4e00-\u9fa5]{2,5}$/.test(el.value) ? "" : "âŒ é™ 2-5 å­—ç´”ä¸­æ–‡");
        window.validatePhone = (el) => toggleError(el, el.value && /^09\d{8}$/.test(el.value) ? "" : "âŒ æ ¼å¼éŒ¯èª¤");
        
        function toggleError(el, msg) {
            let err = el.parentNode.querySelector('.error-message');
            if (el.id === 'lineInput') err = document.getElementById('lineError');
            if(msg) { el.classList.add('input-error'); if(err){ err.style.display='block'; err.innerText=msg;} return false; }
            else { el.classList.remove('input-error'); if(err) err.style.display='none'; return true; }
        }

        window.switchLineMode = () => {
            const mode = document.querySelector('input[name="lineType"]:checked').value;
            const input = document.getElementById('lineInput');
            const hint = document.getElementById('lineHint');
            if (mode === 'id') { 
                input.placeholder = "è«‹è¼¸å…¥ Line ID"; 
                hint.textContent = "ID éœ€ç‚º 2-20 å­—å…ƒï¼Œåƒ…é™å°å¯«è‹±æ–‡ã€æ•¸å­—åŠç¬¦è™Ÿ"; 
                input.oninput = null; 
            } else { 
                input.placeholder = "è«‹è¼¸å…¥ç¶å®šçš„é›»è©±è™Ÿç¢¼"; 
                hint.textContent = "è«‹è¼¸å…¥ 09 é–‹é ­çš„æ‰‹æ©Ÿè™Ÿç¢¼"; 
                input.oninput = function() { restrictNum(this); }; 
            }
        };

        window.validateLine = (el) => {
            const mode = document.querySelector('input[name="lineType"]:checked').value;
            const val = el.value;
            if(!val) return toggleError(el, "âŒ æ­¤æ¬„ä½å¿…å¡«");
            if (mode === 'phone') { return toggleError(el, /^09\d{8}$/.test(val) ? "" : "âŒ æ ¼å¼éŒ¯èª¤"); }
            else { 
                if (/[A-Z]/.test(val)) return toggleError(el, "âŒ ä¸èƒ½æœ‰å¤§å¯«");
                if (!/^[a-z0-9._-]+$/.test(val)) return toggleError(el, "âŒ ç„¡æ•ˆç¬¦è™Ÿ");
                if (val.length < 2 || val.length > 20) return toggleError(el, "âŒ é•·åº¦éŒ¯èª¤");
                toggleError(el, ""); return true;
            }
        };

        window.checkAge = (el) => {
            if(!el.value) return;
            const dob = new Date(el.value);
            const todayDate = new Date();
            if(dob > todayDate) { el.value = ""; return toggleError(el, "âŒ æ—¥æœŸéŒ¯èª¤"); }
            let age = todayDate.getFullYear() - dob.getFullYear();
            if (todayDate.getMonth() < dob.getMonth() || (todayDate.getMonth() === dob.getMonth() && todayDate.getDate() < dob.getDate())) { age--; }
            if (age < 14) return toggleError(el, "âŒ æŠ±æ­‰ï¼Œéœ€å¹´æ»¿ 14 æ­²");
            toggleError(el, ""); return true;
        };

        window.validateAccount = (el) => {
            if(el.value.length === 16) toggleError(el, "âŒ ç–‘ä¼¼å¡«æˆå¡è™Ÿ");
            else toggleError(el, el.value.length >= 10 && el.value.length <= 14 ? "" : "âŒ é•·åº¦æ‡‰ç‚º 10-14 ç¢¼");
        };

        window.handleBankChange = (el) => {
            const isManual = el.value === 'manual';
            document.getElementById('bankCodeManual').style.display = isManual ? 'block' : 'none';
            const nameInput = document.getElementById('bankName');
            nameInput.readOnly = !isManual;
            nameInput.classList.toggle('readonly-input', !isManual);
            if(!isManual && el.selectedIndex > 0) {
                nameInput.value = el.options[el.selectedIndex].text.split(' - ')[1];
            }
        };

        window.saveData = async function() {
            // ğŸ›‘ æ–°å¢æª¢æŸ¥ï¼šé›»è©±å¿…å¡«
            if (!document.getElementById('phone').value) { alert("âŒ è«‹å¡«å¯«é›»è©±è™Ÿç¢¼"); return; }
            
            // åŸæœ‰çš„æª¢æŸ¥
            if (!window.validateLine(document.getElementById('lineInput'))) { alert("âŒ Line æ ¼å¼éŒ¯èª¤"); return; }
            if (document.querySelector('#dob').classList.contains('input-error')) { alert("âŒ ç”Ÿæ—¥æ ¼å¼éŒ¯èª¤"); return; }
            if (!document.getElementById('realName').value || !document.getElementById('bankAccount').value) { alert("âŒ è«‹æª¢æŸ¥å¿…å¡«æ¬„ä½"); return; }
            
            const btn = document.querySelector("button[onclick='saveData()']");
            const originalText = btn.innerText;
            btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;

            let bankCode = document.getElementById('bankCode').value;
            if(bankCode === 'manual') bankCode = document.getElementById('bankCodeManual').value;
            
            let lineInfo = document.getElementById('lineInput').value;
            let lineType = document.querySelector('input[name="lineType"]:checked').value;
            if(lineType === 'phone') lineInfo = "(é›»è©±) " + lineInfo;

            const gender = document.querySelector('input[name="gender"]:checked').value;
            
            const payload = {
                action: "update_member",
                email: currentUserEmail,
                realName: document.getElementById('realName').value,
                birthday: document.getElementById('dob').value,
                phone: document.getElementById('phone').value,
                gender: gender, 
                lineInfo: lineInfo, 
                bankCode: bankCode,
                bankName: document.getElementById('bankName').value,
                account: document.getElementById('bankAccount').value,
                branch: document.getElementById('branchName').value
            };

            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
                const json = await res.json();
                alert(json.status === "success" ? "âœ… æ›´æ–°æˆåŠŸï¼" : "âŒ å¤±æ•—ï¼š" + json.message);
            } catch(e) { 
                alert("é€£ç·šéŒ¯èª¤"); 
            } finally { 
                btn.innerText = originalText; 
                btn.disabled = false; 
            }
        };
    </script>
</body>
</html>

